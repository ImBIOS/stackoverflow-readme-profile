flowchart TB
  subgraph database
    tags[(popupar_tag)]
  end

  subgraph 1: scrapBadges[scrap top badges]
    direction TB
    scrap["scrap SO pages -> https://stackoverflow.com/tags?page=${pageIndex}&tab=popular"]
    scrap -->|get| badges
    badges --> flushBadgeDb["flush tags from db"] ---> tags
    badges --->|forEach| storeBadgesDb[store to db] --> tags
  end

  subgraph authentification
    checkAuth["POST https://data.stackexchange.com/query/run/1/1629390/1986822 \n headers: { Cookie: $cookie } \n body: {tagName: 'random'}"]
    cookieValue --> checkAuth
    checkAuth -->|fetch| authCheckTest{"body.json().captcha"}
    authCheckTest -->|true| manualLogin[get cookie by login manually]
    manualLogin -->|set| cookieValue
    cookieValue[$cookie]
  end

  authentification --> scrapTag

  subgraph scrapTag[scrap top user for tag $tag]
    direction TB
    startJob[start SO job] --> startJobRequest["POST https://data.stackexchange.com/query/run/1/1629390/1986822 \n headers: { Cookie: $cookie } \n body: {tagName: $tag}"]
    cookieValue --> startJobRequest
    startJobRequest -->|fetch| jobRequest["$jobId = response.json().job_id"]
    jobRequest --> startUsersRequest["GET https://data.stackexchange.com/query/job/$jobId \n headers: { Cookie: $cookie }"]
    cookieValue --> startUsersRequest
  end
